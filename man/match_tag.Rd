% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/match.R
\name{match_tag}
\alias{match_tag}
\title{Match STATS19 collisions with TAG (RAS4001) cost estimates}
\usage{
match_tag(
  crashes,
  shapes_url =
    "https://open-geography-portalx-ons.hub.arcgis.com/api/download/v1/items/ad30b234308f4b02b4bb9b0f4766f7bb/geoPackage?layers=0",
  costs_url =
    "https://assets.publishing.service.gov.uk/media/68d421cc275fc9339a248c8e/ras4001.ods",
  match_with = c("severity", "severity_road", "severity_road_bua"),
  include_motorway_bua = FALSE,
  summarise = FALSE
)
}
\arguments{
\item{crashes}{A STATS19 collision data frame. May be \code{sf} or non-\code{sf},
but spatial geometry is required when using \code{"severity_road_bua"}.}

\item{shapes_url}{URL to download the ONS Built-Up Areas geopackage.
Defaults to the official ONS 2022 dataset.}

\item{costs_url}{URL to download the TAG Data Book \strong{RAS4001} table
(ODS format). Defaults to the Department for Transport asset link.}

\item{match_with}{Character string specifying the matching mode.
One of:
\itemize{
\item \code{"severity"}
\item \code{"severity_road"}
\item \code{"severity_road_bua"}
}

The default uses \code{match_with = c("severity", "severity_road", "severity_road_bua")},
so users get tab-completion and help in RStudio.}

\item{include_motorway_bua}{Logical; if \code{TRUE}, motorways inside a built-up
area polygon are treated as \code{"built_up"} rather than \code{"Motorway"}.}

\item{summarise}{Logical; if \code{TRUE}, returns a summary table of total
costs (in millions) grouped by severity and/or road type.}
}
\value{
A data frame (or \code{sf} object if input is \code{sf}) with added columns for
estimated collision costs.
If \code{summarise = TRUE}, a summary table of total costs (in millions) is returned.
}
\description{
Downloads and processes the UK Department for Transport \strong{TAG Data Book}
table \strong{RAS4001}, and joins estimated collision costs to STATS19 data.

Three matching modes are available:
\itemize{
\item \code{"severity"} — cost varies only by collision severity
\item \code{"severity_road"} — cost varies by severity \emph{and} road type
\item \code{"severity_road_bua"} — cost varies by severity & road type, where road
type is determined using \strong{ONS Built-Up Area (BUA)} polygons (2022)
}

BUA polygons are downloaded automatically from:
\url{https://open-geography-portalx-ons.hub.arcgis.com/api/download/v1/items/ad30b234308f4b02b4bb9b0f4766f7bb/geoPackage?layers=0}

Optionally, total costs may be summarised by severity and/or road type.
}
\details{
The function:
\enumerate{
\item Downloads and parses \strong{RAS4001} cost tables
\item Computes road type using STATS19 fields or optional BUA polygons
\item Joins appropriate cost estimates
\item Optionally aggregates totals
}

When \code{crashes} is an \code{sf} object and \code{summarise = TRUE}, geometry is
automatically dropped.
}
\examples{
\dontrun{
  # Simple severity-based matching
  match_tag(stats19_df, match_with = "severity")

  # Severity + road type
  match_tag(stats19_df, match_with = "severity_road")

  # Using ONS Built-Up Areas, with motorway override
  match_tag(
    stats19_df,
    match_with = "severity_road_bua",
    include_motorway_bua = TRUE
  )

  # Summarised totals
  match_tag(stats19_df, match_with = "severity", summarise = TRUE)
}

}
